---
title: "R Notebook"
output: html_notebook
---

```{r setup}
local <- TRUE

wd <- ""

if (!local) {
  # Cluster environment
  wd <- "~/Documents/Autocorrelation"
  # Base directory for the data set we will create
  dat_dir <- "/project_cephfs/3022017.02/projects/lorkno/data"
} else {
  wd <- "~/HPC/Documents/Autocorrelation"
  # Base directory for the data set we will create
  dat_dir <- "~/HPC_project/data"
}

# For some reason this sets the pwd only for the current scope, which means it 
# does not affect anything outside an if block if you set it there.
# So that's why it's here instead of above.
setwd(wd) 

source("src/load_dependencies.R")
```

# Alex's data

```{r}
dat <- read.table("data/2022-09-14 keystroke detail.psv", header = TRUE, sep = "|", comment.char = "")
head(dat)
```

```{r}
table(dat$keypress_type)
```

```{r}
table(dat$sessionTimeZone)
```

```{r}
hist(dat$sampleNumber)
```

```{r}
length(unique(dat$sessionTimestamp))
```

```{r}
dat %>%
  mutate(date = as.POSIXct(sessionTimestamp, origin="1970-01-01", tz="Asia/Taipei")) %>%
  group_by(sessionTimestamp) %>%
  summarise(
    duration = sessionDuration[1],
    sumUnknown1 = sum(X.Unknown1., na.rm = TRUE),
    sumUnknown2 = sum(X.Unknown2., na.rm = TRUE),
    alphanum = sum(keypress_type == "alphanum") / n(),
    autocorrect = sum(keypress_type == "autocorrection") / n(),
    backspace = sum(keypress_type == "backspace") / n(),
    date = date[1]
  )
```

```{r}
dat %>%
  group_by(sessionTimestamp) %>%
  group_modify(function (x, y) {
    if (nrow(x) == 1) {
      return(data.frame())
    }
    
    sel <- 1:(nrow(x)-1) # Original selection
    lagged_sel <- 2:nrow(x) # Lagged selection
    x[sel,]$keypress_type <- paste(x[sel,]$keypress_type, x[lagged_sel,]$keypress_type, sep = "-")
    x[sel,]
  })
```

```{r}
dat
```

# Perimenstrual suicidality data

```{r}
all_rep_dat <- read_sav("../CLEAR3_Biaffect_Leow/2022-12-05 - CLEAR3 Daily Dataset/clear3daily_20221205.sav")
all_rep_dat <- zap_labels(all_rep_dat)
all_rep_dat
```

```{r}
table(all_rep_dat$id)
```

```{r warning=FALSE}
max.print <- options("max.print")$max.print
options(max.print = 10 * max.print)

tab1 <- CreateTableOne(data = all_rep_dat)
print(summary(tab1))

options(max.print = max.print)
```

As for the 05-12-2022 snapshot of the data set, we see many spurious days for a couple of subjects (with `daterated` already starting in 1990). Those days contain no actual data, we will simply throw them out of the data set. First select only the columns with relevant data:

```{r}
inclusion <- read_excel("regression_inclusion_20221205.xlsx")$Included
inclusion <- inclusion[1:ncol(all_rep_dat)]
# Relevant self-report data
rel_rep_dat <- all_rep_dat[inclusion == 1]
rel_rep_dat
```


```{r}
all_missing <- data.frame(is.na(rel_rep_dat)) %>%
  rowwise() %>%
  summarize(allMissing = all(c_across(menstrualbleeding:panicattack)))

# Reduced self-report data
red_rep_dat <- rel_rep_dat[!all_missing$allMissing,]
red_rep_dat
```

A reduction of about 22,000 rows. Let's see what TableOne has to say about the data now. But first we throw out the text responses.

```{r warning=FALSE}
max.print <- options("max.print")$max.print
options(max.print = 10 * max.print)

tab1 <- CreateTableOne(data = red_rep_dat)
print(summary(tab1))

options(max.print = max.print)
```


## Examining subject 3009

```{r}
sub_path <- "data/sub-3009/raw"

raw_kp <- read.csv(file.path(sub_path, "User_3009_keypressDataMetrics.csv"))
raw_acc <- read.csv(file.path(sub_path, "User_3009_accelData.csv"))
```

```{r}
raw_kp
```

```{r}
raw_acc
```


## Handling PSV files

```{r}
dat_dir <- "data"

labels = c("distanceFromCenter", "distanceFromPrevious")

path <- "../CLEAR/Clear lab participants keystroke dynamics data/***REMOVED*** keystroke dynamics data.psv"

sub <- str_match(path, "\\+([0-9]+)")[,2]

intendend_n_pipes <- 14

lin <- read_lines(path)
actual_n_pipes <- str_count(lin[1], "\\|")

sel <- (length(labels) + 1 - (intendend_n_pipes - actual_n_pipes)):length(labels)
new_labels <- paste(labels[sel], collapse = "|")

if (new_labels != "") 
  lin[1] <- paste(lin[1], new_labels, sep = "|")

sub_dir <- str_glue("sub-{sub}")
raw_dir <- file.path(dat_dir, sub_dir, "raw")
dir.create(raw_dir, showWarnings = FALSE, recursive = TRUE)

sub_kp_file <- file.path(raw_dir, str_glue("sub-{sub}_keystrokes.psv"))
write_lines(lin, sub_kp_file)
```

```{r}
raw_kp <- read.table(sub_kp_file, header = TRUE, sep = "|", strip.white = TRUE, fill = TRUE)
raw_kp
```

Things to do for the key press data:

* Convert sessionTimestamp to sessionTimestampLocal. (Note: sessionTimeZone says it's zero, but I don't believe that. Looking, for instance, at the frequency of key strokes over time, it is clear that all timestamps shoud be shifted by createdOnTimeZone instead of sessionTimeZone.)
* Calculate IKD from timestamp.
* Convert timestamp to keypressTimestampLocal.
* Convert sampleNumber to sessionNumber.
* Calculate previousKeyType.

```{r}
raw_kp %>%
  mutate(
    sessionTimestampLocal = as_datetime(sessionTimestamp + createdOnTimeZone * 36),
    keypressTimestampLocal = as_datetime(timestamp + createdOnTimeZone * 36),
    IKD = c(NA, diff(timestamp)),
    previousKeyType = lag(keypress_type),
    sessionNumber = cumsum(sampleNumber == 1)
  ) %>%
  select(!c(sessionTimestamp, sessionTimeZone, sampleNumber))
```

```{r}
dt <- as_datetime(raw_kp$sessionTimestamp)

hist((hour(dt) - 6) %% 24)
```


```{r}
raw_acc <- read.table("../CLEAR/Clear lab participants keyboard accelerometer kinematics data/***REMOVED*** keyboard accelerometer kinematics data.psv", header = TRUE, sep = "|", strip.white = TRUE, fill = TRUE)
raw_acc
```

Things to do for the accelerometer data:

* Convert sessionTimestamp to sessionTimestampLocal. (Note: sessionTimeZone says it's zero, but I don't believe that. Looking, for instance, at the frequency of key strokes over time, it is clear that all timestamps shoud be shifted by createdOnTimeZone instead of sessionTimeZone.)
* Convert sampleNumber to sessionNumber.
* Rename [x,y,z]Coord to [x,y,z].

```{r}
raw_acc %>%
  mutate(
    sessionTimestampLocal = as_datetime(sessionTimestamp + createdOnTimeZone * 36),
    sessionNumber = cumsum(sampleNumber == 1)
  ) %>%
  rename(x = xCoord, y = yCoord, z = zCoord) %>%
  select(!c(sessionTimestamp, sessionTimeZone, sampleNumber))
```


## Trying out pre-processing


```{r}
dat_acc <- preproc_acc(raw_acc, verbose = TRUE)

dats <- preproc_kp(raw_kp, dat_acc, verbose = TRUE)
dat_kp <- dats$dat_kp
dat_ses <- dats$dat_ses
```


```{r}
load("data/sub-3009/preproc/sub-3009_preprocessed.rda")
```

```{r}
dat_kp_alphanum <- dat_kp %>%
    filter(keypress_type == "alphanum", previousKeyType == "alphanum")
```

Aggregating per hour:

```{r}
dat_hour <- dat_ses %>%
  group_by(date, hour) %>%
  summarize(
    totalKeyPresses = sum(totalKeyPresses),
    active = sum(active) / n(),
    upright = sum(upright) / n(),
    bed = sum(bed) / n()
  )

head(dat_hour)
```

```{r fig.height=8, fig.width=20}
ggplot(dat_hour %>% pivot_longer(c(active, upright), names_to = "modality", values_to = "proportion")) +
  geom_point(aes(hour, date, color = proportion, size = totalKeyPresses)) +
  facet_grid(cols = vars(modality)) +
  scale_color_gradientn(colors = hcl.colors(256)) +
  theme_light() + 
  theme(text = element_text(size = 18), panel.border = element_blank())

# ggsave("images/typing_pattern.png", width = 1920, height = 1080, units = "px", dpi = 110)

ggplot(dat_hour) +
  geom_point(aes(hour, date, color = bed, size = totalKeyPresses)) +
  scale_color_gradientn(colors = rev(hcl.colors(256))) +
  theme_light() + 
  theme(text = element_text(size = 18), panel.border = element_blank())
```

```{r fig.height=9}
ggpairs(dat_ent %>% select(!c(year, week)), 
        progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggsave("images/splom.png", width = 1920, height = 1080, dpi = 120, unit = "px")
```

# Self-report data

```{r}
rep_file <- "../CLEAR3_Biaffect_Leow/Archived Versions/2022-02-15 - Updated Daily Dataset for Elena and Alex/20220215_clear3daily.csv"
dat_rep <- read.csv(rep_file)
head(dat_rep)
```

For now, only look at the self-report data of our subject of the key press data.

```{r}
dat_rep <- dat_rep %>%
  filter(id == dat_kp$userID[1]) %>%
  mutate(daterated = as.Date(daterated, format = "%m/%d/%Y"))

dat_rep
```

Join with the key press session and entropy data:

```{r}
dat_rep_ent <- dat_rep %>%
  group_by(
    year = year(daterated),
    week = week(daterated)
  ) %>%
  summarize(
    menstrualbleeding = mean(menstrualbleeding, na.rm = T),
    numdrinks_yest = mean(numdrinks_yest, na.rm = T),
    workday = mean(workday, na.rm = T),
    sleepdur_yest = mean(sleepdur_yest, na.rm = T),
    physicaltension = mean(physicaltension, na.rm = T),
    wishsleep = mean(wishsleep, na.rm = T),
    MJuse = mean(MJuse, na.rm = T),
    irritability_mean = mean(irritability_mean, na.rm = T)
  ) %>%
  left_join(dat_ent, by = c("year", "week")) %>%
  ungroup()
```

```{r fig.height=8}
ggplot(dat_rep, aes(x = daterated)) + 
  geom_line(aes(y = irritability_mean, color = KL_divergence, group = 1), size = 1.05) +
  geom_point(aes(y = firstdayofperiod)) + 
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-07-11"))) + 
  scale_color_gradientn(colors = hcl.colors(256, palette = "viridis")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
stress_cols <- na.omit(str_extract(colnames(dat_rep), "^stress.*"))
ggplot(dat_rep %>%
    pivot_longer(all_of(stress_cols), names_to = "stress")) +
  geom_point(aes(x = daterated, y = value, color = stress)) + 
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-04-01"))) + 
  scale_fill_manual(values = hcl.colors(15)) +
  ylim(0, 1.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Anything that can predict divergence? Time for a SPLOM (scatter plot matrix).

```{r fig.height=10, warning=FALSE}
# menstrualbleeding, 
# numdrinks_yest, 
# workday, 
# sleepdur_yest, 
# physicaltension, 
# wishsleep, 
# MJuse, 
# irritability_mean,
# entropy,
# KL_divergence


ggpairs(dat_rep_ent %>% 
          select(!c(year, week)),
  progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# save_and_plot(h, "images/splom_self_rep.png", res = 120)
```

# Examine all subjects data

Determine data missingness, number of days, etc.

```{r}
dirs <- list.dirs(dat_dir)

pattern <- "sub-([0-9]+)/preproc$"
preproc_paths <- str_subset(dirs, pattern)
subjects <- as.integer(str_match(preproc_paths, pattern)[,2])

n_sub <- length(subjects)
dats_acc <- vector("list", n_sub)
dats_kp <- vector("list", n_sub)
dats_ses <- vector("list", n_sub)
```

First load all relevant data. This might take a while.

```{r}
for (i in 1:length(subjects)) {
  sub <- subjects[i]
  
  print(str_glue("Loading subject {sub}..."))
  
  preproc_path <- preproc_paths[i]
  load(file.path(preproc_path, str_glue("sub-{sub}_preprocessed.rda")))
  
  dats_acc[[i]] <- dat_acc
  dats_kp[[i]] <- dat_kp
  dats_ses[[i]] <- dat_ses
}
```

Save lists separately, using high compression. Hopefully that will reduce loading overhead next time.

```{r}
save(dats_acc, file = file.path(dat_dir, "dats_acc.rda"), compress = "xz")
save(dats_kp, file = file.path(dat_dir, "dats_kp.rda"), compress = "xz")
save(dats_ses, file = file.path(dat_dir, "dats_ses.rda"), compress = "xz")
```

```{r}
load(file.path(dat_dir, "dats_kp.rda"))
load(file.path(dat_dir, "dats_ses.rda"))
```


```{r}
diagnostics <- data.frame(subject = subjects, 
                          n_days = vector("integer", length(subjects)))

for (i in 1:length(subjects)) {
  diagnostics[i,]$n_days <- n_distinct(dats_ses[[i]]$date)
}

diagnostics
```

```{r}
hist(diagnostics$n_days, main = "Histogram of number of key press data days per subject",
     xlab = "Number of days of data per subject")
```

```{r}
all_rep_dat <- read_sav(file.path(dat_dir, "clear3daily_20220801.sav"))
all_rep_dat <- zap_labels(all_rep_dat)
all_rep_dat
```

```{r}
nan_summary <- all_rep_dat %>%
  group_by(id) %>%
  summarize(
    n_days = n(),
    across(menstrualbleeding:LHgroup_perimenstrual_count, ~ mean(is.na(.x)), .names = "{.col}NA")
  )

nan_summary
```

```{r fig.height=20}
par(mfrow = c(10, ceiling(ncol(nan_summary) / 10)))

for (i in 2:ncol(nan_summary)) {
  hist(nan_summary[[i]], main = colnames(nan_summary)[i])
}
```

```{r}
hist(nan_summary[[2]])
```

```{r}
all_rep_dat %>%
  group_by(id) %>%
  summarize(
    n_days = n(),
    na_cases = n() - complete.cases(cur_data())
  )
```



# Subject 2D histogram correlation matrices

```{r}
ls <- get_partitions(dat_dir)
subjects <- ls$dat$subjects
dats_kp <- ls$dat$dats_kp
dats_ses <- ls$dat$dats_ses
subject_mats <- ls$subject_mats
```

```{r}
save(subject_mats, file = file.path(dat_dir, "subject_mats.rda"))
```

```{r fig.height=10}
n_sub <- length(subjects)

for (i in 1:n_sub) {
  cors <- cor(sapply(subject_mats[[i]], as.vector))
  g1 <- ggplot(melt(cors), aes(X1, X2)) +
    geom_raster(aes(fill = value)) + 
    scale_y_reverse() +
    ggtitle(str_glue("Subject {subjects[i]}"))
  
  df <- data.frame(mean_cor = colMeans(cors), X1 = 1:ncol(cors))
  g2 <- ggplot(df, aes(X1, mean_cor)) +
    geom_line() +
    geom_point() +
    ylim(0, 1) +
    scale_x_continuous(breaks = seq(0, ncol(cors), 10), 
                       minor_breaks = 1:ncol(cors)) +
    ylab("Mean correlation")
  
  acfs <- apply(cors, 1, acf, lag.max = 300, plot = FALSE)
  df <- melt(t(sapply(acfs, function(x) x$acf)))
  g3 <- ggplot(df, aes(X2, value)) +
    geom_point(alpha = 0.2) +
    scale_x_continuous(breaks = seq(0, ncol(cors), 10), 
                       minor_breaks = 1:ncol(cors)) +
    xlab("X1") +
    ylab("Autocorrelation")
  
  g <- ggarrange(g1, g2, g3, nrow = 3, common.legend = TRUE)
  
  print(g)
  
  ggsave(str_glue("images/autocorrelation/correlations/sub-{subjects[i]}_cor-mat_autocor.png"))
}
```

```{r}
cors <- cor(sapply(subject_mats[[which(subjects == "3083")]], as.vector))
ggplot(melt(cors), aes(X1, X2)) +
  geom_raster(aes(fill = value)) + 
  scale_y_reverse() +
  ggtitle(str_glue("Subject 3083")) +
  labs(fill = "Correlation")

ggsave("images/autocorrelation/correlations/sub-3083_cor_mat.png")
```

# Confusion matrix of TDIA calculation

```{r}
ls <- parse_tdia_jld(file.path(dat_dir, "tdias_flattened_p.jld"))
conf_mat <- ls$conf_mat
```

```{r fig.height=8}
# Something to be aware of: X2 indicates the column number, not the row number
ggplot(melt(conf_mat), aes(X2, X1)) +
  geom_raster(aes(fill = value)) + 
  scale_y_reverse()

ggplot(melt(conf_mat), aes(X2, X1)) +
  geom_raster(aes(fill = log(value))) + 
  scale_y_reverse()
```

```{r fig.height=8}
b <- barplot(colSums(conf_mat))
axis(1, b, labels = 1:ncol(conf_mat))
```

