---
title: "R Notebook"
output: html_notebook
---

```{r setup}
library(gsignal)
library(tidyverse)
library(GGally)
library(scales)
library(lubridate)

filter <- dplyr::filter

setwd("M:/Documents/Autocorrelation")
```

# Alex's data

```{r}
dat <- read.table("data/2022-09-14 keystroke detail.psv", header = TRUE, sep = "|", comment.char = "")
head(dat)
```

```{r}
table(dat$keypress_type)
```

```{r}
table(dat$sessionTimeZone)
```




```{r}
hist(dat$sampleNumber)
```

```{r}
length(unique(dat$sessionTimestamp))
```

```{r}
dat %>%
  mutate(date = as.POSIXct(sessionTimestamp, origin="1970-01-01", tz="Asia/Taipei")) %>%
  group_by(sessionTimestamp) %>%
  summarise(
    duration = sessionDuration[1],
    sumUnknown1 = sum(X.Unknown1., na.rm = TRUE),
    sumUnknown2 = sum(X.Unknown2., na.rm = TRUE),
    alphanum = sum(keypress_type == "alphanum") / n(),
    autocorrect = sum(keypress_type == "autocorrection") / n(),
    backspace = sum(keypress_type == "backspace") / n(),
    date = date[1]
  )
```

```{r}
dat %>%
  group_by(sessionTimestamp) %>%
  group_modify(function (x, y) {
    if (nrow(x) == 1) {
      return(data.frame())
    }
    
    sel <- 1:(nrow(x)-1) # Original selection
    lagged_sel <- 2:nrow(x) # Lagged selection
    x[sel,]$keypress_type <- paste(x[sel,]$keypress_type, x[lagged_sel,]$keypress_type, sep = "-")
    x[sel,]
  })
```


```{r}
dat
```

# Perimenstrual suicidality data

```{r}
dat_kp <- read.csv("data/User_3009_keypressDataMetrics.csv")
dat_kp
```

```{r}
dat_kp <- dat_kp %>%
  mutate(
    date = as.Date(date, format = "%Y-%m-%d"),
    keypressTimestampLocal = as.POSIXct(keypressTimestampLocal, format = "%Y-%m-%d %H:%M:%OS"),
    sessionTimestampLocal = as.POSIXct(keypressTimestampLocal, format = "%Y-%m-%d %H:%M:%OS")
  )
```

```{r}
dat_acc <- read.csv("data/User_3009_accelData.csv")
dat_acc
```

```{r}
dat_acc <- dat_acc %>%
  mutate(
    date = as.Date(date, format = "%Y-%m-%d"),
    sessionTimestampLocal = as.POSIXct(sessionTimestampLocal, format = "%Y-%m-%d %H:%M:%OS")
  )
```


```{r}
dat_kp_avg <- dat_kp %>%
  mutate(hour = format(keypressTimestampLocal, "%H")) %>%
  group_by(hour, sessionNumber) %>%
  summarise(medianIKD = median(IKD, na.rm = TRUE)) %>%
  group_by(hour) %>%
  summarise(meanIKD = mean(medianIKD, na.rm = TRUE))
  
plot(dat_kp_avg$hour, dat_kp_avg$meanIKD, type = "b")
```



# Playing with filters

```{r}
but <- butter(2, w = 0.8, plane = "z", type = "low", output = "Sos")
but
```

```{r fig.height=8}
freqz(but, fs = 10)
```

```{r}
zplane(but) # Filter is stable, poles (X) lie in unit circle
```

```{r}
acc_max_ses <- dat_acc %>%
  group_by(sessionNumber) %>%
  mutate(N = n()) %>%
  ungroup() %>%
  filter(N == max(N))
head(acc_max_ses)
```

```{r}
long_acc_ses <- acc_max_ses %>%
  mutate(idx = 1:n()) %>%
  select(idx, sessionTimestampLocal, x, y, z) %>%
  pivot_longer(c(x, y, z), names_to = "direction")

ggplot(long_acc_ses) +
  geom_line(aes(x = idx, y = value, color = direction))
```

```{r}
long_acc_ses <- long_acc_ses %>%
  group_by(direction) %>%
  mutate(filtered = gsignal::filtfilt(but, value))
```

```{r fig.height=8}
ggplot(long_acc_ses, aes(x = idx, color = direction)) +
  geom_line(aes(y = filtered), size = 1.1) +
  geom_line(aes(y = value), linetype = "dotted", size = 1.1) +
  xlim(800, 900)
```

Actually applying the filter per session:

```{r}
dat_acc <- dat_acc %>%
  group_by(sessionNumber) %>%
  mutate(
    xFiltered = filtfilt(but, x),
    yFiltered = filtfilt(but, y),
    zFiltered = filtfilt(but, z)
  )
```

Mark samples and sessions as active or not active.

```{r}
dat_acc <- dat_acc %>%
  mutate(
    magnitude = sqrt(xFiltered^2 + yFiltered^2 + zFiltered ^2),
    activeSample = magnitude < 0.95 | magnitude > 1.05
  ) %>%
  group_by(sessionNumber) %>%
  mutate(
    activeSes = sum(activeSample) / n() > 0.08,
    xMedian = median(xFiltered),
    zMedian = median(zFiltered),
    upright = zMedian < 0.1 & xMedian >= -0.2 & xMedian <= 0.2
  )
```

```{r}
ggplot(dat_acc) +
  geom_point(aes(x = xFiltered, y = zFiltered, color = upright), alpha = 0.1)
```

# Calculating session level data

```{r}
dat_acc_ses <- dat_acc %>%
  group_by(sessionNumber) %>%
  summarize(
    active = activeSes[1],
    upright = upright[1]
  )

dat_acc_ses

dat_ses <- dat_kp %>%
  group_by(sessionNumber) %>%
  mutate(
    autocorrectRate = sum(keypress_type == "autocorrection") / n(),
    backspaceRate = sum(keypress_type == "backspace") / n(),
    totalKeyPresses = n()
  ) %>%
  left_join(dat_acc_ses, by = "sessionNumber") %>%
  filter(keypress_type == "alphanum", previousKeyType == "alphanum") %>%
  summarize(
    medianIKD = median(IKD, na.rm = TRUE),
    percent95IKD = quantile(IKD, .95, na.rm = TRUE),
    madIKD = mad(IKD, na.rm = TRUE),
    autocorrectRate = autocorrectRate[1],
    backspaceRate = backspaceRate[1],
    sessionTimestampLocal = sessionTimestampLocal[1],
    totalKeyPresses = totalKeyPresses[1],
    active = active[1],
    upright = upright[1],
    hour = format(sessionTimestampLocal, "%H"),
    date = as.Date(sessionTimestampLocal)
  )

dat_ses
```

Aggregating per hour:

```{r}
dat_hour <- dat_ses %>%
  group_by(date, hour) %>%
  summarize(
    totalKeyPresses = sum(totalKeyPresses),
    active = sum(active) / n(),
    upright = sum(upright) / n()
  )

head(dat_hour)
```

```{r fig.height=8, fig.width=20}
ggplot(dat_hour %>% pivot_longer(c(active, upright), names_to = "modality", values_to = "proportion")) +
  geom_point(aes(hour, date, color = proportion, size = totalKeyPresses)) +
  facet_grid(cols = vars(modality)) +
  scale_color_gradientn(colors = hcl.colors(256)) +
  theme_light() + 
  theme(text = element_text(size = 18), panel.border = element_blank())

ggsave("images/typing_pattern.png", width = 1920, height = 1080, units = "px", dpi = 110)
```


Interesting (but perhaps also expected) to see the effect of the number of key presses on the median vs mad distribution. Few key presses means low variability even at high median IKDs.

```{r}
with(dat_ses, {
  plot(medianIKD, madIKD, main = "All sessions")
})

with(filter(dat_ses, totalKeyPresses > 10), {
  plot(medianIKD, madIKD, main = "Sessions with >10 key presses")
})
```

```{r fig.height=8}
dat_ses_avg <- dat_ses %>%
  filter(sessionTimestampLocal > 10) %>%
  group_by(hour) %>%
  summarise(
    SE = sd(medianIKD) / sqrt(n()),
    meanIKD = mean(medianIKD),
    N = n()
  )

with(dat_ses_avg, {
  par(mfrow = c(2, 1))
  
  plot(hour, meanIKD, type = "b", 
       main = "Mean of median IKDs over 24 hours",
       ylim = c(0.2, 0.6))
  grid(NA, NULL)

  x <- 0:(length(hour)-1)
  arrows(x, meanIKD - SE, x, meanIKD + SE, length = 0.05, angle = 90, code = 3)
  
  plot(hour, N, type = "b", 
       main = "Number of recorded sessions over 24 hours",
       ylim = c(0, 600))
})
```

```{r fig.height=8}
with(dat_ses, {
  nColors <- 256
  pal <- hcl.colors(nColors)
  medianIKD_idx <- pmin(floor(1/medianIKD / quantile(1/medianIKD, .95) * nColors), nColors)
  hist(medianIKD_idx)
  
  plot(hour, date, pch = 20, cex = log(totalKeyPresses / 10), 
       col = pal[medianIKD_idx], bty = "n")
  grid(NULL, NULL)
})
```

```{r fig.height=8}
ggplot(dat_ses) +
  geom_point(aes(hour, date, color = 1 / medianIKD, size = totalKeyPresses)) +
  scale_color_gradientn(colors = hcl.colors(256)) +
  theme_light() + 
  theme(text = element_text(size = 18), panel.border = element_blank())
```

# Entropy

```{r}
dat_kp_alphanum <- dat_kp %>%
  filter(keypress_type == "alphanum", previousKeyType == "alphanum")

ggplot(dat_kp_alphanum) +
  geom_point(aes(x = distanceFromPrevious, y = IKD), alpha = 0.2)
```

```{r}
save_and_plot <- function(h, title, res = 200) {
  png(title, width = 1920, height = 1080, res = res)
  print(h)
  dev.off()
  
  print(h)
}
```


```{r fig.height=7}
h <- ggplot(dat_kp_alphanum, aes(x = distanceFromPrevious, y = IKD)) +
  geom_bin_2d(bins = 100) +
  labs(x = "distanceFromPrevious (iPhone 12 points)", y = "IKD (s)") +
  scale_fill_continuous(type = "viridis")

save_and_plot(h, "images/hist2d_overall.png")

h <- ggplot(dat_kp_alphanum, aes(x = distanceFromPrevious, y = IKD)) +
  geom_bin_2d(bins = 100) +
  scale_x_continuous(limits = c(0, 300)) +
  scale_y_continuous(limits = c(0, 0.5)) +
  scale_fill_continuous(type = "viridis")

save_and_plot(h, "images/hist2d_overall_zoomed.png")
```

Extract the 2D histogram from the ggplot object. From that histogram, we will calculate breaks to be used in the construction of histograms of subsets of the data.

```{r}
h <- ggplot(dat_kp_alphanum, aes(x = distanceFromPrevious, y = IKD)) +
  geom_bin_2d(bins = 100)

hist2d <- ggplot_build(h)$data[[1]]

edges <- list(x = sort(unique(hist2d$xmin)), y = sort(unique(hist2d$ymin)))

hist2d
```

Partition the data in time frames of a month, calculate the normalised 2D histograms, and then calculate the KL divergence from the first month.

We denote the overall histogram as our model distribution $Q$, and all other, time-windowed histograms as our observation distributions $P$. (I would have liked to set $Q$ to the very first time-windowed histogram, but then we run into division by 0 problems, leading to infinite relative entropy.)

Prepare for some next-level data wrangling.

```{r}
histQ <- ggplot_build(
  ggplot(dat_kp_alphanum, aes(x = distanceFromPrevious, y = IKD)) +
    geom_bin_2d(breaks = edges))$data[[1]]

hists <- dat_kp_alphanum %>%
  group_by(
    year = year(sessionTimestampLocal), 
    month = month(sessionTimestampLocal), 
    week = week(sessionTimestampLocal)
  ) %>%
  nest() %>%
  mutate(
    hist = map(data, function (df) {
      h <- ggplot_build(
        ggplot(df, aes(x = distanceFromPrevious, y = IKD)) +
          geom_bin_2d(breaks = edges)
      )
      
      # png(paste("images/hist2d_week_", cur_group_id(), ".png", sep = ""), 
      #     width = 1920, height = 1080, res = 200)
      # print(h)
      # dev.off()
      
      h$data[[1]]
    }),
    entropy = map_dbl(hist, function(hist) {
      sum(hist$density * log2(1 / hist$density))
    }),
    KL_divergence = map_dbl(hist, function(hist) {
      joint <- hist %>%
        full_join(histQ, by = c("xbin", "ybin"), suffix = c(".P", ".Q")) %>%
        filter(!is.na(density.P))
      
      sum(joint$density.P * log2(joint$density.P / joint$density.Q))
    })
  )

hists
```

```{r, fig.height=8}
png("images/entropy.png", width = 1650, height = 1200, res = 200)

par(mfrow = c(2, 1), mai = c(1, 1, 0.1, 0.1))
with(hists, {
  plot(week, entropy, type = "b", col = "steelblue", lwd = 2)
  grid(NULL, NULL)
  plot(week, KL_divergence, type = "b", col = "darkred", lwd = 2)
  grid(NULL, NULL)
})

dev.off()
```


```{r}
dat_kp_kl <- hists %>%
  unnest(cols = data) %>% 
  group_by(sessionNumber) %>%
  summarize(
    entropy = entropy[1],
    KL_divergence = KL_divergence[1]
  )

dat_ses <- dat_ses %>%
  inner_join(dat_kp_kl, by = "sessionNumber")

dat_ses
```

```{r fig.height=9}
ggpairs(dat_ses %>% 
          filter(totalKeyPresses > 10) %>%
          group_by(date) %>%
          summarise(
            medianIKD = mean(medianIKD),
            percent95IKD = mean(percent95IKD),
            madIKD = mean(madIKD),
            autocorrectRate = mean(autocorrectRate),
            backspaceRate = mean(backspaceRate),
            active = mean(active),
            upright = mean(upright),
            entropy = entropy[1],
            KL_divergence = KL_divergence[1]
          ) %>%
          select(!c(date)),
        progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

ggsave("images/splom.png", width = 1920, height = 1080, dpi = 120, unit = "px")
```

```{r}
png("images/splom.png", width = 1920, height = 1080, res = 120)

ggpairs(dat_ses %>% 
          filter(totalKeyPresses > 10) %>%
          select(!c(sessionNumber, hour, sessionTimestampLocal, date, active, upright)),
        progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

dev.off()
```


# Self-report data

```{r}
rep_file <- "../CLEAR3_Biaffect_Leow/Archived Versions/2022-02-15 - Updated Daily Dataset for Elena and Alex/20220215_clear3daily.csv"
dat_rep <- read.csv(rep_file)
head(dat_rep)
```

Write table of every column:

```{r}
fname <- "rep_var_tables.txt"
file.create(fname)

for (col in colnames(dat_rep)) {
  write(paste("#######################", col, "#######################\n"), file = fname, append = TRUE)
  
  write.table(table(dat_rep[[col]]), file = fname, append = TRUE)
}
```

For now, only look at the self-report data of our subject of the key press data.

```{r}
dat_rep <- dat_rep %>%
  filter(id == dat_kp$userID[1]) %>%
  mutate(daterated = as.Date(daterated, format = "%m/%d/%Y"))

dat_rep
```

Join with the KL divergence data:

```{r}
kl_div <- select(hists, year, month, week, entropy, KL_divergence)

dat_rep <- dat_rep %>%
  mutate(
    year = year(daterated), 
    month = month(daterated), 
    week = week(daterated)
  ) %>%
  left_join(kl_div, by = c("year", "month", "week"))

dat_rep
```


```{r}
ggplot(dat_rep, aes(x = daterated)) +
  geom_line(aes(y = KL_divergence), size = 1.05) +
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-07-11")))
```


```{r fig.height=8}
ggplot(dat_rep, aes(x = daterated)) + 
  geom_line(aes(y = irritability_mean, color = KL_divergence, group = 1), size = 1.05) +
  geom_point(aes(y = firstdayofperiod)) + 
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-07-11"))) + 
  scale_color_gradientn(colors = hcl.colors(256, palette = "viridis")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
stress_cols <- na.omit(str_extract(colnames(dat_rep), "^stress.*"))
ggplot(dat_rep %>%
    pivot_longer(all_of(stress_cols), names_to = "stress")) +
  geom_point(aes(x = daterated, y = value, color = stress)) + 
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-04-01"))) + 
  scale_fill_manual(values = hcl.colors(15)) +
  ylim(0, 1.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Anything that can predict divergence? Time for a SPLOM (scatter plot matrix).

```{r fig.height=8}
h <- ggpairs(dat_rep %>% select(
  menstrualbleeding, 
  numdrinks_yest, 
  workday, 
  sleepdur_yest, 
  physicaltension, 
  wishsleep, 
  MJuse, 
  irritability_mean,
  entropy,
  KL_divergence),
  progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

save_and_plot(h, "images/splom_self_rep.png", res = 120)
```

# Merging self-rep and typing data, in some way

```{r}
dat_ses_day <- dat_ses %>%
  filter(totalKeyPresses > 10) %>%
  group_by(date) %>%
  summarise(
    medianIKD = mean(medianIKD),
    percent95IKD = mean(percent95IKD),
    madIKD = mean(madIKD),
    autocorrectRate = mean(autocorrectRate),
    backspaceRate = mean(backspaceRate),
    active = mean(active),
    upright = mean(upright),
    entropy = entropy[1],
    KL_divergence = KL_divergence[1]
  )
  
```

```{r}
dat_rep_tmp <- read.csv(rep_file) %>%
  filter(id == dat_kp$userID[1]) %>%
  mutate(
    daterated = as.Date(daterated, format = "%m/%d/%Y"),
    menstrualbleeding = as.factor(menstrualbleeding),
    workday = as.factor(workday),
    physicaltension = as.factor(physicaltension),
    wishsleep = as.factor(wishsleep),
    MJuse = as.factor(MJuse),
  )

dat_rep_tmp
```

```{r}
dat_ses_rep <- dat_ses_day %>%
  inner_join(dat_rep_tmp, by = c("date" = "daterated"))

dat_ses_rep
```

```{r fig.height=10, fig.width=20}
ggpairs(dat_ses_rep %>%
    select(
      medianIKD,
      upright,
      menstrualbleeding, 
      numdrinks_yest, 
      workday, 
      sleepdur_yest, 
      physicaltension, 
      wishsleep, 
      MJuse, 
      irritability_mean,
      entropy,
      KL_divergence
    ),
  progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggsave("images/splom_ses_rep.png", width = 1920, height = 1080, dpi = 100, units = "px")
```


