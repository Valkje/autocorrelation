---
title: "R Notebook"
output: html_notebook
---

```{r setup}
setwd("M:/Documents/Autocorrelation")

source("src/load_dependencies.R")
```

# Alex's data

```{r}
dat <- read.table("data/2022-09-14 keystroke detail.psv", header = TRUE, sep = "|", comment.char = "")
head(dat)
```

```{r}
table(dat$keypress_type)
```

```{r}
table(dat$sessionTimeZone)
```

```{r}
hist(dat$sampleNumber)
```

```{r}
length(unique(dat$sessionTimestamp))
```

```{r}
dat %>%
  mutate(date = as.POSIXct(sessionTimestamp, origin="1970-01-01", tz="Asia/Taipei")) %>%
  group_by(sessionTimestamp) %>%
  summarise(
    duration = sessionDuration[1],
    sumUnknown1 = sum(X.Unknown1., na.rm = TRUE),
    sumUnknown2 = sum(X.Unknown2., na.rm = TRUE),
    alphanum = sum(keypress_type == "alphanum") / n(),
    autocorrect = sum(keypress_type == "autocorrection") / n(),
    backspace = sum(keypress_type == "backspace") / n(),
    date = date[1]
  )
```

```{r}
dat %>%
  group_by(sessionTimestamp) %>%
  group_modify(function (x, y) {
    if (nrow(x) == 1) {
      return(data.frame())
    }
    
    sel <- 1:(nrow(x)-1) # Original selection
    lagged_sel <- 2:nrow(x) # Lagged selection
    x[sel,]$keypress_type <- paste(x[sel,]$keypress_type, x[lagged_sel,]$keypress_type, sep = "-")
    x[sel,]
  })
```

```{r}
dat
```

# Perimenstrual suicidality data

Load all subjects key press data into one big data frame:

```{r}
dat_dir <- "data"

pattern <- "sub-([0-9]+)"
subjects <- str_match(dir(dat_dir, pattern), pattern)[,2]

dat_all_kp <- data.frame()

for (sub in subjects) {
  sub_dir <- file.path(dat_dir, str_glue("sub-{sub}"), "preproc")
  
  load(file.path(sub_dir, str_glue("sub-{sub}_preprocessed.rda")))
  
  if ("sessionDuration_minus6sec" %in% colnames(dat_kp)) {
    dat_kp <- dat_kp %>%
      select(!c(sessionDuration_minus6sec, session_duration))
  } else {
    dat_kp <- dat_kp %>%
      select(!firstKP_timestamp)
  }
  
  dat_all_kp <- rbind(dat_all_kp, dat_kp)
}

dat_all_kp
```

```{r}
dat_all_kp %>%
  group_by(phoneType, userID) %>%
  summarize(
    distPrevMin = min(distanceFromPrevious, na.rm = TRUE),
    distPrevMax = max(distanceFromPrevious, na.rm = TRUE))
```

```{r}
screen_specs
```
```{r}
str_match("Unknown iPhone [iPhone12 X Plus]", "iPhone(\\s?\\w+(?:\\s\\w+)?(?:\\s\\w+)?)-?")
```


## Examining subject 3009

```{r}
sub_path <- "data/sub-3009/raw"

raw_kp <- read.csv(file.path(sub_path, "User_3009_keypressDataMetrics.csv"))
raw_acc <- read.csv(file.path(sub_path, "User_3009_accelData.csv"))
```

```{r}
screen_specs %>% filter(phoneType == "iPhone 12 ")
```


```{r}
screen_specs <- read.delim("data/iPhone_screen_specs.tsv", strip.white = TRUE)
  
points_to_cm <- function(dist, phoneType) {
  if (is.na(dist) || is.na(phoneType)) {
    return(NA)
  }
  
  pType <- str_match(phoneType, "iPhone(\\s?\\w+(?:\\s\\w+)?(?:\\s\\w+)?)-?")[,2]
  pType <- paste("iPhone", pType)
  
  spec <- screen_specs %>% filter(phoneType == pType)
  
  # Multiply with scale factor to get physical pixels, divide by ppi to
  # get inches, convert to centimeters by multiplying with 2.54
  return(dist * spec$scaleFactor / spec$PPI * 2.54)
}

raw_kp %>%
  mutate(
    distanceFromPrevious = map2_dbl(distanceFromPrevious, phoneType, points_to_cm),
    # distanceFromCenter = map_dbl(distanceFromCenter, points_to_cm, phoneType)
  )

str(list(c(1, 2), c(3, 4)))
```


```{r}
dat_acc <- preproc_acc(raw_acc, verbose = TRUE)

dats <- preproc_kp(raw_kp, dat_acc, verbose = TRUE)
dat_kp <- dats$dat_kp
dat_ses <- dats$dat_ses
```


```{r}
load("data/sub-3009/preproc/sub-3009_preprocessed.rda")
```

```{r}
dat_kp_alphanum <- dat_kp %>%
    filter(keypress_type == "alphanum", previousKeyType == "alphanum")
```

Aggregating per hour:

```{r}
dat_hour <- dat_ses %>%
  group_by(date, hour) %>%
  summarize(
    totalKeyPresses = sum(totalKeyPresses),
    active = sum(active) / n(),
    upright = sum(upright) / n(),
    bed = sum(bed) / n()
  )

head(dat_hour)
```

```{r fig.height=8, fig.width=20}
ggplot(dat_hour %>% pivot_longer(c(active, upright), names_to = "modality", values_to = "proportion")) +
  geom_point(aes(hour, date, color = proportion, size = totalKeyPresses)) +
  facet_grid(cols = vars(modality)) +
  scale_color_gradientn(colors = hcl.colors(256)) +
  theme_light() + 
  theme(text = element_text(size = 18), panel.border = element_blank())

# ggsave("images/typing_pattern.png", width = 1920, height = 1080, units = "px", dpi = 110)

ggplot(dat_hour) +
  geom_point(aes(hour, date, color = bed, size = totalKeyPresses)) +
  scale_color_gradientn(colors = rev(hcl.colors(256))) +
  theme_light() + 
  theme(text = element_text(size = 18), panel.border = element_blank())
```

```{r fig.height=9}
ggpairs(dat_ent %>% select(!c(year, week)), 
        progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# ggsave("images/splom.png", width = 1920, height = 1080, dpi = 120, unit = "px")
```

# Self-report data

```{r}
rep_file <- "../CLEAR3_Biaffect_Leow/Archived Versions/2022-02-15 - Updated Daily Dataset for Elena and Alex/20220215_clear3daily.csv"
dat_rep <- read.csv(rep_file)
head(dat_rep)
```

For now, only look at the self-report data of our subject of the key press data.

```{r}
dat_rep <- dat_rep %>%
  filter(id == dat_kp$userID[1]) %>%
  mutate(daterated = as.Date(daterated, format = "%m/%d/%Y"))

dat_rep
```

Join with the key press session and entropy data:

```{r}
dat_rep_ent <- dat_rep %>%
  group_by(
    year = year(daterated),
    week = week(daterated)
  ) %>%
  summarize(
    menstrualbleeding = mean(menstrualbleeding, na.rm = T),
    numdrinks_yest = mean(numdrinks_yest, na.rm = T),
    workday = mean(workday, na.rm = T),
    sleepdur_yest = mean(sleepdur_yest, na.rm = T),
    physicaltension = mean(physicaltension, na.rm = T),
    wishsleep = mean(wishsleep, na.rm = T),
    MJuse = mean(MJuse, na.rm = T),
    irritability_mean = mean(irritability_mean, na.rm = T)
  ) %>%
  left_join(dat_ent, by = c("year", "week")) %>%
  ungroup()
```

```{r fig.height=8}
ggplot(dat_rep, aes(x = daterated)) + 
  geom_line(aes(y = irritability_mean, color = KL_divergence, group = 1), size = 1.05) +
  geom_point(aes(y = firstdayofperiod)) + 
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-07-11"))) + 
  scale_color_gradientn(colors = hcl.colors(256, palette = "viridis")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
stress_cols <- na.omit(str_extract(colnames(dat_rep), "^stress.*"))
ggplot(dat_rep %>%
    pivot_longer(all_of(stress_cols), names_to = "stress")) +
  geom_point(aes(x = daterated, y = value, color = stress)) + 
  scale_x_date(labels = date_format("%Y-%m"), limits = c(min(dat_rep$daterated), as.Date("2021-04-01"))) + 
  scale_fill_manual(values = hcl.colors(15)) +
  ylim(0, 1.1) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

Anything that can predict divergence? Time for a SPLOM (scatter plot matrix).

```{r fig.height=10, warning=FALSE}
# menstrualbleeding, 
# numdrinks_yest, 
# workday, 
# sleepdur_yest, 
# physicaltension, 
# wishsleep, 
# MJuse, 
# irritability_mean,
# entropy,
# KL_divergence


ggpairs(dat_rep_ent %>% 
          select(!c(year, week)),
  progress = FALSE) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# save_and_plot(h, "images/splom_self_rep.png", res = 120)
```

# Visualise for all subjects

```{r warning=FALSE, fig.height=10}
rep_file <- "../CLEAR3_Biaffect_Leow/Archived Versions/2022-02-15 - Updated Daily Dataset for Elena and Alex/20220215_clear3daily.csv"
dat_rep_all <- read.csv(rep_file)

dat_dir <- "data"

pattern <- "sub-([0-9]+)"
subjects <- str_match(dir(dat_dir, pattern), pattern)[,2]

for (sub in subjects) {
  sub_dir <- file.path(dat_dir, str_glue("sub-{sub}"), "preproc")
  
  load(file.path(sub_dir, str_glue("sub-{sub}_preprocessed.rda")))
  
  dat_rep <- dat_rep_all %>%
    filter(id == dat_kp$userID[1]) %>%
    mutate(daterated = as.Date(daterated, format = "%m/%d/%Y"))
  
  dat_rep_ent <- dat_rep %>%
    group_by(
      year = year(daterated),
      week = week(daterated)
    ) %>%
    summarize(
      menstrualbleeding = mean(menstrualbleeding, na.rm = T),
      numdrinks_yest = mean(numdrinks_yest, na.rm = T),
      workday = mean(workday, na.rm = T),
      sleepdur_yest = mean(sleepdur_yest, na.rm = T),
      physicaltension = mean(physicaltension, na.rm = T),
      wishsleep = mean(wishsleep, na.rm = T),
      MJuse = mean(MJuse, na.rm = T),
      irritability_mean = mean(irritability_mean, na.rm = T)
    ) %>%
    left_join(dat_ent, by = c("year", "week")) %>%
    ungroup()
  
  h <- ggpairs(dat_rep_ent %>% 
            select(!c(year, week)),
    progress = FALSE) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
  ggsave(file.path(dat_dir, str_glue("sub-{sub}_splom.png")), 
         plot = h,
         width = 1920,
         height = 1080,
         units = "px",
         dpi = 100)
}
```

